name: Build PlexMusicPlayer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Linux binary
        run: |
          pyinstaller -F --add-data "MusicApp.iconset/icon_256x256.png:icon" plex_music_player/__main__.py
          mv dist/__main__ PlexMusicPlayer_linux_x86_64

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_linux_x86_64
          path: PlexMusicPlayer_linux_x86_64

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Windows binary
        run: |
          pyinstaller -i icon_win.ico -F --add-data "MusicApp.iconset/icon_256x256.png;icon" --windowed .\plex_music_player\__main__.py
          Move-Item -Path dist\__main__.exe -Destination PlexMusicPlayer_windows_x86-64.exe

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_windows_x86-64
          path: PlexMusicPlayer_windows_x86-64.exe

  build-macos:
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            runs-on: macos-13
          - arch: arm64
            runs-on: macos-14

    runs-on: ${{ matrix.runs-on }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build macOS app
        run: |
          python setup.py py2app
          mv dist PlexMusicPlayer_macos_${{ matrix.arch }}

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_macos_${{ matrix.arch }}
          path: PlexMusicPlayer_macos_${{ matrix.arch }}

  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug directory structure
        run: |
          echo "=== Listing artifacts directory ==="
          ls -la artifacts/
          echo "=== Listing macOS x86_64 directory ==="
          ls -la artifacts/PlexMusicPlayer_macos_x86_64/
          echo "=== Listing macOS arm64 directory ==="
          ls -la artifacts/PlexMusicPlayer_macos_arm64/
          echo "=== Finding .app files ==="
          find artifacts -name "*.app" -type d
          echo "=== Current working directory ==="
          pwd
          echo "=== Directory tree ==="
          tree artifacts/

      - name: Generate Changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const previousTag = releases.length > 0 ? releases[0].tag_name : 'initial';
            
            // Get commits between current and previous release
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: previousTag,
              head: context.sha
            });
            
            const changelog = commits.commits.map(commit => {
              const message = commit.commit.message.split('\n')[0];
              const author = commit.commit.author.name;
              return `- ${message} (by ${author})`;
            }).join('\n');
            
            return changelog;

   create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # … предыдущие шаги … #

      - name: Download macOS x86_64 ZIP without unpacking
        uses: dawidd6/action-download-artifact@v9
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          name: PlexMusicPlayer_macos_x86_64
          skip_unpack: true   # <— не распаковываем, скачиваем raw .zip  [oai_citation_attribution:0‡GitHub](https://github.com/dawidd6/action-download-artifact)
          path: artifacts

      - name: Download macOS arm64 ZIP without unpacking
        uses: dawidd6/action-download-artifact@v9
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          name: PlexMusicPlayer_macos_arm64
          skip_unpack: true
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: |
            PlexMusicPlayer v${{ github.event.inputs.version }}

            ## Changes
            ${{ steps.changelog.outputs.result }}

            ## Downloads
            - Linux (x86_64)
            - Windows (x86-64)
            - macOS (x86_64, arm64)
          files: |
            artifacts/PlexMusicPlayer_linux_x86_64/PlexMusicPlayer_linux_x86_64
            artifacts/PlexMusicPlayer_windows_x86-64/PlexMusicPlayer_windows-x86-64.exe
            artifacts/PlexMusicPlayer_macos_x86_64.zip
            artifacts/PlexMusicPlayer_macos_arm64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
