name: Build PlexMusicPlayer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Linux binary
        run: |
          pyinstaller -F --add-data "MusicApp.iconset/icon_256x256.png:icon" plex_music_player/__main__.py
          mv dist/__main__ PlexMusicPlayer_linux_x86_64

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_linux_x86_64
          path: PlexMusicPlayer_linux_x86_64

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Windows binary
        run: |
          pyinstaller -i icon_win.ico -F --add-data "MusicApp.iconset/icon_256x256.png;icon" --windowed .\plex_music_player\__main__.py
          Move-Item -Path dist\__main__.exe -Destination PlexMusicPlayer_windows_x86-64.exe

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_windows_x86-64
          path: PlexMusicPlayer_windows_x86-64.exe

  build-macos:
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            runs-on: macos-13
          - arch: arm64
            runs-on: macos-14

    runs-on: ${{ matrix.runs-on }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build macOS app
        run: |
          python setup.py py2app
          mv dist PlexMusicPlayer_macos_${{ matrix.arch }}

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: PlexMusicPlayer_macos_${{ matrix.arch }}
          path: PlexMusicPlayer_macos_${{ matrix.arch }}

  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const previousTag = releases.length > 0 ? releases[0].tag_name : 'initial';
            
            // Get commits between current and previous release
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: previousTag,
              head: context.sha
            });
            
            const changelog = commits.commits.map(commit => {
              return `- ${commit.commit.message.split('\n')[0]}`;
            }).join('\n');
            
            return changelog;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: |
            PlexMusicPlayer v${{ github.event.inputs.version }}
            
            ## Changes
            ${{ steps.changelog.outputs.result }}
            
            ## Downloads
            - Linux (x86_64)
            - Windows (x86-64)
            - macOS (x86_64, arm64)
          files: |
            artifacts/PlexMusicPlayer_linux_x86_64/PlexMusicPlayer_linux_x86_64
            artifacts/PlexMusicPlayer_windows_x86-64/PlexMusicPlayer_windows_x86-64.exe
            artifacts/PlexMusicPlayer_macos_x86_64/PlexMusicPlayer.app
            artifacts/PlexMusicPlayer_macos_arm64/PlexMusicPlayer.app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
